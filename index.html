<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AI Real-time Manzai</title>
    <style>
        * { touch-action: none !important; -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        html, body { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; margin: 0; padding: 0; background: #0a0a0a; overflow: hidden; overscroll-behavior: none; }
        body { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #fff; font-family: 'Helvetica Neue', Arial, sans-serif; }

        /* ステージ演出 */
        .stage { width: 90%; max-width: 400px; height: 40%; background: radial-gradient(circle at bottom, #333, #000); border-bottom: 8px solid #a00; border-radius: 20px; display: flex; justify-content: center; align-items: flex-end; gap: 40px; position: relative; margin-bottom: 20px; }
        .comic { width: 70px; height: 120px; background: #eee; border-radius: 35px 35px 5px 5px; position: relative; transition: transform 0.1s; }
        .comic::after { content: ''; position: absolute; top: 20px; left: 15px; width: 40px; height: 40px; border-radius: 50%; background: #ddd; }
        .mic { width: 8px; height: 100px; background: #555; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); z-index: 10; }
        
        /* セリフ窓 */
        #caption-box { width: 90%; min-height: 120px; background: rgba(255,255,255,0.1); border: 1px solid #444; border-radius: 15px; padding: 20px; text-align: center; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; line-height: 1.6; color: #0f0; }

        /* 操作系 */
        .controls { margin-top: 30px; display: flex; flex-direction: column; gap: 15px; width: 80%; }
        button { padding: 20px; font-size: 18px; font-weight: bold; border: none; border-radius: 50px; cursor: pointer; }
        #gen-btn { background: #d2b48c; color: #1a0a00; box-shadow: 0 5px 0 #5d2e0c; }
        #gen-btn:active { transform: translateY(3px); box-shadow: 0 2px 0 #5d2e0c; }
        #gen-btn:disabled { background: #555; color: #888; box-shadow: none; transform: none; }
    </style>
</head>
<body>

    <div id="caption-box">ボタンを押してネタを生成してください</div>

    <div class="stage">
        <div id="ai-1" class="comic"></div>
        <div class="mic"></div>
        <div id="ai-2" class="comic"></div>
    </div>

    <div class="controls">
        <button id="gen-btn" onclick="generateManzai()">新ネタを生成する</button>
    </div>

    <script>
        // --- 設定エリア ---
        const API_KEY = 'AIzaSyDARyV0N7zA1GWYT-b7fI_pcoAZ2j1g9uY'; // ここを自分のAPIキーに変える
        const PROMPT = "あなたは日本一の漫才師です。ボケとツッコミの2人組による爆笑漫才の台本を書いてください。形式は「A：セリフ」「B：セリフ」とし、最後は必ず「もうええわ！」で締めてください。短めでテンポ良くお願いします。";

        let isPlaying = false;

        async function generateManzai() {
            if (isPlaying) return;
            const box = document.getElementById('caption-box');
            const btn = document.getElementById('gen-btn');
            
            isPlaying = true;
            btn.disabled = true;
            box.innerText = "ネタを考えています...";

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: PROMPT }] }] })
                });

                const data = await response.json();
                const fullText = data.candidates[0].content.parts[0].text;
                const scriptLines = fullText.split('\n').filter(line => line.includes('：') || line.includes(':'));
                
                playScript(scriptLines);
            } catch (error) {
                box.innerText = "エラー: APIキーを確認してください。";
                isPlaying = false;
                btn.disabled = false;
            }
        }

        function playScript(lines) {
            let index = 0;
            const box = document.getElementById('caption-box');

            function nextLine() {
                if (index < lines.length) {
                    const line = lines[index];
                    box.innerText = line;

                    // キャラクターの動き（Aなら左、Bなら右）
                    const targetId = line.startsWith('A') ? 'ai-1' : 'ai-2';
                    const el = document.getElementById(targetId);
                    el.style.transform = "translateY(-15px) scale(1.05)";
                    setTimeout(() => el.style.transform = "translateY(0) scale(1)", 200);

                    index++;
                    setTimeout(nextLine, 2000); // 2秒間隔で進む
                } else {
                    isPlaying = false;
                    document.getElementById('gen-btn').disabled = false;
                }
            }
            nextLine();
        }

        // 鉄壁のズレ防止（これまでの成功コード）
        let lastT = 0;
        document.addEventListener('touchstart', e => {
            const now = Date.now();
            if (now - lastT < 300 || e.touches.length > 1) e.preventDefault();
            lastT = now;
        }, { passive: false });
    </script>
</body>
</html>
