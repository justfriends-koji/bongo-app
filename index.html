<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>AI Manzai LIVE</title>

  <style>
    /* ===== iOS Safariで壊れにくい“固定” =====
       - 全要素 touch-action:none はやらない（タップが死ぬ原因）
       - html/body fixed はやらない（高さ計算が崩れる原因）
       - overflow/overscrollでスクロールを止める
    */

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    html, body {
      margin: 0;
      padding: 0;
      background: #000;
      color: #fff;
      font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      height: 100%;
    }

    /* 画面を1枚に固定：スクロール禁止 */
    body {
      overflow: hidden;
      overscroll-behavior: none;
      -webkit-overflow-scrolling: auto;
      touch-action: manipulation; /* タップは許す。ピンチズーム等は抑制寄り */
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }

    /* iOSのアドレスバー出入りでも崩れにくい：dvh優先、なければvh */
    .app {
      width: 100vw;
      height: 100vh;     /* fallback */
      height: 100dvh;    /* modern iOS */
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center;

      /* セーフエリア対応（ノッチ） */
      padding:
        calc(24px + env(safe-area-inset-top))
        20px
        calc(24px + env(safe-area-inset-bottom));
      gap: 16px;
    }

    /* セリフ表示エリア */
    #caption-box {
      width: min(560px, 95vw);
      min-height: 140px;
      background: rgba(255,255,255,0.10);
      border: 2px solid #333;
      border-radius: 15px;
      padding: 18px 16px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      line-height: 1.6;
      color: #0f0;
    }

    /* 漫才ステージ */
    .stage {
      width: min(400px, 90vw);
      height: 42dvh;
      max-height: 360px;
      background: radial-gradient(circle at bottom, #333, #000);
      border-bottom: 8px solid #b00;
      border-radius: 20px;
      display: flex;
      justify-content: center;
      align-items: flex-end;
      gap: 40px;
      position: relative;
    }

    .comic {
      width: 70px;
      height: 130px;
      background: #fff;
      border-radius: 35px 35px 5px 5px;
      position: relative;
      transform: translateY(0) scale(1);
      transition: transform 0.12s ease;
      will-change: transform;
    }

    .mic {
      width: 8px;
      height: 110px;
      background: #777;
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      border-radius: 4px;
    }

    /* 操作ボタン */
    #gen-btn {
      width: min(560px, 80vw);
      padding: 20px 18px;
      font-size: 18px;
      font-weight: 800;
      border: none;
      border-radius: 999px;
      background: #d2b48c;
      color: #1a0a00;
      box-shadow: 0 6px 0 #5d2e0c;
      cursor: pointer;
      touch-action: manipulation; /* ボタンは確実にタップを通す */
    }
    #gen-btn:active { transform: translateY(4px); box-shadow: 0 2px 0 #5d2e0c; }
    #gen-btn:disabled { background: #555; color: #888; box-shadow: none; cursor: not-allowed; }
  </style>
</head>

<body>
  <div class="app">
    <div id="caption-box">ボタンを押すと、AIが新ネタを考え始めます</div>

    <div class="stage" aria-label="漫才ステージ">
      <div id="ai-1" class="comic" aria-label="ボケ A"></div>
      <div class="mic" aria-hidden="true"></div>
      <div id="ai-2" class="comic" aria-label="ツッコミ B"></div>
    </div>

    <button id="gen-btn" type="button">新ネタを生成する</button>
  </div>

  <script>
    // ===== 1) 設定：APIキー =====
    const API_KEY = 'ここにあなたのAPIキーを貼り付け';

    // ===== 2) プロンプト =====
    const PROMPT =
      "あなたは日本一の漫才師です。ボケ(A)とツッコミ(B)の2人組による爆笑漫才を書いてください。ルール：1.必ず「A：」「B：」という形式で交互に話すこと。2.最後は必ず「もうええわ！」で締めること。3.文字数は短めでテンポ重視。";

    const box = document.getElementById('caption-box');
    const btn = document.getElementById('gen-btn');

    let isPlaying = false;
    let timerIds = [];

    function clearTimers() {
      timerIds.forEach(id => clearTimeout(id));
      timerIds = [];
    }

    function setCaption(text) {
      box.textContent = text;
    }

    function bounce(id) {
      const el = document.getElementById(id);
      el.style.transform = "translateY(-18px) scale(1.05)";
      const t = setTimeout(() => {
        el.style.transform = "translateY(0) scale(1)";
      }, 180);
      timerIds.push(t);
    }

    async function generateManzai() {
      if (isPlaying) return;

      // APIキー未設定ガード
      if (!API_KEY || API_KEY.includes('ここにあなたのAPIキー')) {
        setCaption("APIキーが未設定です。コード内の API_KEY を差し替えてください。");
        return;
      }

      isPlaying = true;
      btn.disabled = true;
      clearTimers();
      setCaption("ネタを構築中...");

      try {
        const url =
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${encodeURIComponent(API_KEY)}`;

        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: PROMPT }] }]
          })
        });

        // HTTPエラーを明示
        if (!response.ok) {
          const errText = await response.text().catch(() => "");
          throw new Error(`HTTP ${response.status} ${response.statusText} ${errText}`.trim());
        }

        const data = await response.json();

        // APIのエラー形式
        if (data?.error?.message) throw new Error(data.error.message);

        // candidatesが無い/空のケースに備える
        const fullText = data?.candidates?.[0]?.content?.parts?.[0]?.text;
        if (!fullText || typeof fullText !== "string") {
          throw new Error("AIの返答を取得できませんでした（candidates が空、または形式が想定外）。");
        }

        // セリフ行だけ抽出（A: / A： / B: / B：）
        const scriptLines = fullText
          .split('\n')
          .map(s => s.trim())
          .filter(line => /^[AB][：:]/.test(line));

        if (!scriptLines.length) {
          // 念のため：抽出できなければ全文表示（短く）
          setCaption(fullText.slice(0, 140) + (fullText.length > 140 ? "…" : ""));
          isPlaying = false;
          btn.disabled = false;
          return;
        }

        playManzai(scriptLines);

      } catch (error) {
        console.error(error);
        setCaption("APIエラー：キー/権限/制限、またはネットワークを確認してください。");
        isPlaying = false;
        btn.disabled = false;
      }
    }

    function playManzai(lines) {
      let i = 0;

      const showNextLine = () => {
        if (i < lines.length) {
          const line = lines[i];
          setCaption(line);

          const targetId = line.startsWith('A') ? 'ai-1' : 'ai-2';
          bounce(targetId);

          i++;
          const t = setTimeout(showNextLine, 2200);
          timerIds.push(t);
        } else {
          isPlaying = false;
          btn.disabled = false;
        }
      };

      showNextLine();
    }

    // ボタンイベント（onclick属性より安定）
    btn.addEventListener('click', generateManzai);

    // 画面回転/アドレスバー変動でも安定させたい場合の保険（必要なら）
    // ここでは高さ再計算を強制しないので、事故りにくい
    window.addEventListener('orientationchange', () => {
      // 何もしない（必要なら後で調整）
    });
  </script>
</body>
</html>
